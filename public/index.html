<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FunCaptcha</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div id="popupOverlay">
    <div id="funCaptchaBox">
        <h1>FunCaptcha</h1>

        <!-- Loader -->
        <div id="searchFrame" class="loaderWrap" aria-live="polite">
            <div class="spinner" aria-hidden="true"></div>
            <p class="small" id="searchText">Looking for captchas…</p>
        </div>

        <!-- Captcha content -->
        <div id="captchaFrame" class="captchaContent" aria-hidden="true">
            <div class="counter" id="captchaCounter">1 of 5</div>
            <p class="small" id="taskText">Listen to the audio and enter your ID:</p> 

            <input type="text" id="userIdInput" placeholder="Type here..." autocomplete="off" />
            <div id="invalidMsg" class="invalidMsg">Invalid input</div>

            <div class="controls">
                <button id="audioBtn" type="button" aria-pressed="false">🔊 Play</button>
                <button id="checkBtn" type="button">✅ Done</button>
            </div>

            <!-- subtle session id display (will be filled after server returns) -->
            <div id="sessionId" class="sessionId" aria-hidden="true"></div>

            <div id="finishedMsg" class="finishedText" style="display:none">All captchas completed! 🎉</div>
        </div>

    </div>
</div>

<audio id="testAudio" preload="auto">
    Your browser does not support audio.
</audio>

<script>
(function(){
    const searchFrame = document.getElementById('searchFrame');
    const captchaFrame = document.getElementById('captchaFrame');
    const captchaCounter = document.getElementById('captchaCounter');
    const taskText = document.getElementById('taskText');
    const userIdInput = document.getElementById('userIdInput');
    const audioBtn = document.getElementById('audioBtn');
    const checkBtn = document.getElementById('checkBtn');
    const finishedMsg = document.getElementById('finishedMsg');
    const invalidMsg = document.getElementById('invalidMsg');
    const audio = document.getElementById('testAudio');
    const sessionIdEl = document.getElementById('sessionId');

    let currentCaptcha = 0;
    const totalCaptcha = 5;
    let currentSessionId = null;
    let baseAudioUrl = null;
    let firstHalfHasMore = false;

    // Funktion zum Aktualisieren des Audio-Button-Texts
    function updateAudioButtonText() {
        if (audio.paused) {
            audioBtn.textContent = '🔊 Play';
        } else {
            audioBtn.textContent = '⏸️ Pause';
        }
    }

    // Funktion zum Erstellen der Audio-URL basierend auf dem aktuellen Captcha
    function getAudioUrlForCurrentCaptcha() {
        if (!baseAudioUrl) return '';
        
        // Bestimme den Challenge-Wert basierend auf currentCaptcha und firstHalfHasMore
        let challengeValue;
        if (!firstHalfHasMore) {
            // Erste Hälfte: 1=0, 2=1, 3=2, 4=3, 5=4
            challengeValue = currentCaptcha - 1;
        } else {
            // Zweite Hälfte: 1=5, 2=6, 3=7, 4=8, 5=9
            challengeValue = currentCaptcha + 4;
        }
        
        // Ersetze den challenge-Parameter in der URL
        return baseAudioUrl.replace(/challenge=\d+/, `challenge=${challengeValue}`);
    }
    function renderInstruction(instruction) {
        if (!instruction) return '';

        // Trenne Text und strong-Wörter
        const [textPart, strongPart] = instruction.split('$');
        let html = textPart || '';

        // Falls strong-Wörter enthalten sind → markiere sie im Text
        if (strongPart) {
            const strongWords = strongPart.split(',').map(w => w.trim()).filter(Boolean);
            for (const word of strongWords) {
                // Nur ganze Wörter ersetzen, nicht Teilwörter
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                html = html.replace(regex, `<strong>${word}</strong>`);
            }
        }

        // Zeilenumbrüche erhalten
        html = html.replace(/\n/g, '<br>');

        return html;
    }
;

    // --- initial search: call server API, show loader for ~2s, then reveal first captcha ---
    async function startSearchAndShowCaptcha(){
        // show loader
        searchFrame.style.display = 'flex';
        captchaFrame.style.display = 'none';
        captchaFrame.setAttribute('aria-hidden','true');
        sessionIdEl.textContent = ''; // clear

        try {
            // Lokaler Server-Request → dieser holt die Captchas vom Remote-Server
            const res = await fetch('/api/request-captcha', { method: 'GET', cache: 'no-store' });
            const j = await res.json();

            if(j && j.sessionId){
                currentSessionId = j.sessionId;
                baseAudioUrl = j.captchaUrl;
                let instruction = j.instruction; // let statt const, da wir es ändern
                firstHalfHasMore = j.firstHalfHasMore;
                
                sessionIdEl.textContent = `${currentSessionId}`;
                sessionIdEl.setAttribute('aria-hidden','false');
            
                instruction = instruction.replace(/\n/g, '<br><br>');
                const taskText = document.getElementById('taskText');
                taskText.innerHTML = renderInstruction(instruction);
                
                console.log("Captcha empfangen:", {
                    sessionId: currentSessionId,
                    audioUrl: baseAudioUrl,
                    firstHalfHasMore: firstHalfHasMore,
                    dataAnalysis: j.dataAnalysis
                });
            }
        } catch (err) {
            console.warn('captcha session request failed', err);
        }

        // nach Erhalt der Captchas 1 Sekunde warten, bevor UI zeigt
        setTimeout(() => {
            searchFrame.style.display = 'none';
            captchaFrame.style.display = 'block';
            captchaFrame.setAttribute('aria-hidden','false');
            currentCaptcha = 1;
            updateCounter();
            resetForNewCaptcha();
        }, 1000);
    }

    function updateCounter(){
        captchaCounter.textContent = `${currentCaptcha} of ${totalCaptcha}`;
    }

    function resetForNewCaptcha(){
        finishedMsg.style.display='none';
        invalidMsg.style.display='none';
        invalidMsg.setAttribute('aria-hidden','true');

        userIdInput.style.display='';
        audioBtn.style.display='';
        checkBtn.style.display='';

        userIdInput.value='';
        userIdInput.placeholder='Type here...';
        audio.pause();
        audio.currentTime=0;
        updateAudioButtonText(); // Button-Text zurücksetzen
        audioBtn.setAttribute('aria-pressed','false');

        // Setze die Audio-URL für das aktuelle Captcha
        const audioUrl = getAudioUrlForCurrentCaptcha();
        if (audioUrl) {
            audio.src = audioUrl;
            console.log(`Audio URL für Captcha ${currentCaptcha}: ${audioUrl}`);
        }

        // if no session id was returned, sessionIdEl remains empty
        if (currentSessionId) {
            sessionIdEl.style.display = ''; // ensure visible
        } else {
            sessionIdEl.style.display = 'none';
        }
    }

    audioBtn.addEventListener('click', () => {
        if (audio.paused) { 
            audio.play().catch((err) => {
                console.error('Audio playback failed:', err);
            }); 
            audioBtn.setAttribute('aria-pressed','true'); 
        }
        else { 
            audio.pause(); 
            audioBtn.setAttribute('aria-pressed','false'); 
        }
        updateAudioButtonText(); // Button-Text aktualisieren
    });

    // Audio-Events für automatische Text-Änderung
    audio.addEventListener('play', updateAudioButtonText);
    audio.addEventListener('pause', updateAudioButtonText);
    audio.addEventListener('ended', updateAudioButtonText);

    userIdInput.addEventListener('input', ()=>{
        if(userIdInput.value.length>0) userIdInput.placeholder='';
        else userIdInput.placeholder='Type here...';
    });
    userIdInput.addEventListener('focus', ()=>{ if(userIdInput.value.length===0) userIdInput.placeholder=''; });
    userIdInput.addEventListener('blur', ()=>{ if(userIdInput.value.length===0) userIdInput.placeholder='Type here...'; });

    // Validation: only '1','2','3' allowed
    function isValidInput(val){
        return ['1','2','3'].includes(val.trim());
    }

    // Vorhandener Code...

    checkBtn.addEventListener('click', ()=>{
        const val = userIdInput.value;
        if(!isValidInput(val)){
            invalidMsg.style.display='block';
            invalidMsg.setAttribute('aria-hidden','false');
            return; // stop captcha progression
        } else {
            invalidMsg.style.display='none';
            invalidMsg.setAttribute('aria-hidden','true');
        }

        // Antwort an lokalen Server senden
        submitAnswerToServer(val);

        // reset audio (do not autoplay next)
        audio.pause();
        audio.currentTime = 0;
        audioBtn.setAttribute('aria-pressed','false');
        updateAudioButtonText(); // Button-Text zurücksetzen

        if(currentCaptcha < totalCaptcha){
            currentCaptcha++;
            updateCounter();
            userIdInput.value='';
            userIdInput.placeholder='Type here...';
            // Audio-URL für das nächste Captcha aktualisieren
            const nextAudioUrl = getAudioUrlForCurrentCaptcha();
            if (nextAudioUrl) {
                audio.src = nextAudioUrl;
                console.log(`Audio URL für Captcha ${currentCaptcha}: ${nextAudioUrl}`);
            }
        } else {
            // final state inside same captcha frame
            captchaCounter.textContent='All captchas completed!';
            taskText.innerHTML='You have successfully completed all captchas.';
            userIdInput.style.display='none';
            audioBtn.style.display='none';
            checkBtn.style.display='none';
            finishedMsg.style.display='block';
        }
    });

    // NEUE FUNKTION: Antwort an Server senden
    async function submitAnswerToServer(answer) {
        if (!currentSessionId) {
            console.warn('Keine Session-ID verfügbar');
            return;
        }
    
        try {
            const response = await fetch('/api/submit-captcha', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
            },
                body: JSON.stringify({
                    sessionId: currentSessionId,
                    captchaNumber: currentCaptcha,
                    userAnswer: answer
                })
            });

            const result = await response.json();
            
            if (result.success) {
                console.log(`Antwort für Captcha ${currentCaptcha} gespeichert:`, result);
            
                if (result.completed) {
                    console.log('✅ Alle Captchas abgeschlossen und an Hauptserver gesendet!', result.uploadResult);
                    // Optional: Erfolgsmeldung anzeigen
                    setTimeout(() => {
                        alert('Alle Captchas erfolgreich abgeschlossen und übertragen! 🎉');
                    }, 500);
                }
            } else {
                console.error('Fehler beim Speichern der Antwort:', result.message);
            }
        } catch (error) {
            console.error('Netzwerkfehler beim Senden der Antwort:', error);
        }
    }

// Vorhandener Code...
    
    userIdInput.addEventListener('keydown',(e)=>{
        if(e.key==='Enter'){ e.preventDefault(); checkBtn.click(); }
    });

    startSearchAndShowCaptcha();
})();
</script>
</body>
</html>

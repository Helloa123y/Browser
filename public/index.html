<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FunCaptcha</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div id="popupOverlay">
    <div id="funCaptchaBox">
        <h1>FunCaptcha</h1>

        <!-- Loader -->
        <div id="searchFrame" class="loaderWrap" aria-live="polite">
            <div class="spinner" aria-hidden="true"></div>
            <p class="small" id="searchText">Looking for captchas…</p>
        </div>

        <!-- Captcha content -->
        <div id="captchaFrame" class="captchaContent" aria-hidden="true">
            <div class="counter" id="captchaCounter">1 of 5</div>
            <p class="small" id="taskText">Listen to the audio and enter your ID:</p> 

            <input type="text" id="userIdInput" placeholder="Type here..." autocomplete="off" />
            <div id="invalidMsg" class="invalidMsg">Invalid input</div>

            <div class="controls">
                <button id="audioBtn" type="button" aria-pressed="false">🔊 Play</button>
                <button id="checkBtn" type="button">✅ Done</button>
            </div>

            <!-- subtle session id display (will be filled after server returns) -->
            <div id="sessionId" class="sessionId" aria-hidden="true"></div>

            <div id="finishedMsg" class="finishedText" style="display:none">All captchas completed! 🎉</div>
        </div>
        <!-- Ladeoverlay (wird beim Submit gezeigt) -->
    <div id="loadingOverlay" class="loadingOverlay" aria-hidden="true">
        <div class="loaderSpinner"></div>
        <p class="loaderText">Submitting your answer...</p>
    </div>

    <!-- Abschlussanzeige nach letztem Captcha -->
    <div id="thankYouScreen" class="thankYouScreen" style="display:none;">
        <div class="checkmark">✅</div>
        <p id="thankYouText" class="thankYouText">
            Thank you for helping Moon Games to provide you with more games
        </p>
    </div>

    </div>
</div>

<audio id="testAudio" preload="auto">
    Your browser does not support audio.
</audio>

<script>
(function(){
    const searchFrame = document.getElementById('searchFrame');
    const captchaFrame = document.getElementById('captchaFrame');
    const captchaCounter = document.getElementById('captchaCounter');
    const taskText = document.getElementById('taskText');
    const userIdInput = document.getElementById('userIdInput');
    const audioBtn = document.getElementById('audioBtn');
    const checkBtn = document.getElementById('checkBtn');
    const finishedMsg = document.getElementById('finishedMsg');
    const invalidMsg = document.getElementById('invalidMsg');
    const audio = document.getElementById('testAudio');
    const sessionIdEl = document.getElementById('sessionId');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const thankYouScreen = document.getElementById('thankYouScreen');
    const thankYouText = document.getElementById('thankYouText');

    let currentCaptcha = 0;
    const totalCaptcha = 5;
    let currentSessionId = null;
    let baseAudioUrl = null;
    let firstHalfHasMore = false;

    // --- Audio-Button Text ---
    function updateAudioButtonText() {
        audioBtn.textContent = audio.paused ? '🔊 Play' : '⏸️ Pause';
    }

    // --- Audio-URL bestimmen ---
    function getAudioUrlForCurrentCaptcha() {
        if (!baseAudioUrl) return '';
        let challengeValue;
        if (!firstHalfHasMore) challengeValue = currentCaptcha - 1;
        else challengeValue = currentCaptcha + 4;
        return baseAudioUrl.replace(/challenge=\d+/, `challenge=${challengeValue}`);
    }

    // --- Text Rendering (Anleitung) ---
    function renderInstruction(instruction) {
        if (!instruction) return '';
        const [textPart, strongPart] = instruction.split('$');
        let html = textPart || '';
        if (strongPart) {
            const strongWords = strongPart.split(',').map(w => w.trim()).filter(Boolean);
            for (const word of strongWords) {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                html = html.replace(regex, `<strong>${word}</strong>`);
            }
        }
        return html.replace(/\n/g, '<br>');
    }

    // --- Start: Captcha Session anfordern ---
    async function startSearchAndShowCaptcha(){
        searchFrame.style.display = 'flex';
        captchaFrame.style.display = 'none';
        captchaFrame.setAttribute('aria-hidden','true');
        sessionIdEl.textContent = '';

        try {
            const res = await fetch('/api/request-captcha', { method: 'GET', cache: 'no-store' });
            const j = await res.json();

            if(j && j.sessionId){
                currentSessionId = j.sessionId;
                baseAudioUrl = j.captchaUrl;
                firstHalfHasMore = j.firstHalfHasMore;
                
                sessionIdEl.textContent = `${currentSessionId}`;
                sessionIdEl.setAttribute('aria-hidden','false');
                taskText.innerHTML = renderInstruction(j.instruction);

                console.log("Captcha empfangen:", j);
            }
        } catch (err) {
            console.warn('captcha session request failed', err);
        }

        // Nach 1 Sekunde Captcha anzeigen
        setTimeout(() => {
            searchFrame.style.display = 'none';
            captchaFrame.style.display = 'block';
            captchaFrame.setAttribute('aria-hidden','false');
            currentCaptcha = 1;
            updateCounter();
            resetForNewCaptcha();
        }, 1000);
    }

    function updateCounter(){
        captchaCounter.textContent = `${currentCaptcha} of ${totalCaptcha}`;
    }

    function resetForNewCaptcha(){
        finishedMsg.style.display='none';
        invalidMsg.style.display='none';
        invalidMsg.setAttribute('aria-hidden','true');
        userIdInput.style.display='';
        audioBtn.style.display='';
        checkBtn.style.display='';
        userIdInput.value='';
        userIdInput.placeholder='Type here...';
        audio.pause();
        audio.currentTime=0;
        updateAudioButtonText();
        audioBtn.setAttribute('aria-pressed','false');

        const audioUrl = getAudioUrlForCurrentCaptcha();
        if (audioUrl) {
            audio.src = audioUrl;
            console.log(`Audio URL für Captcha ${currentCaptcha}: ${audioUrl}`);
        }
    }

    // --- Audio Button ---
    audioBtn.addEventListener('click', () => {
        if (audio.paused) { 
            audio.play().catch(err => console.error('Audio playback failed:', err));
            audioBtn.setAttribute('aria-pressed','true'); 
        } else { 
            audio.pause(); 
            audioBtn.setAttribute('aria-pressed','false'); 
        }
        updateAudioButtonText();
    });

    audio.addEventListener('play', updateAudioButtonText);
    audio.addEventListener('pause', updateAudioButtonText);
    audio.addEventListener('ended', updateAudioButtonText);

    // --- Input Verhalten ---
    userIdInput.addEventListener('input', ()=> userIdInput.placeholder = userIdInput.value ? '' : 'Type here...');
    userIdInput.addEventListener('focus', ()=>{ if(!userIdInput.value) userIdInput.placeholder=''; });
    userIdInput.addEventListener('blur', ()=>{ if(!userIdInput.value) userIdInput.placeholder='Type here...'; });

    // --- Validation ---
    function isValidInput(val){ return ['1','2','3'].includes(val.trim()); }

    // --- Check Button ---
    checkBtn.addEventListener('click', ()=>{
        const val = userIdInput.value.trim();
        if(!isValidInput(val)){
            invalidMsg.style.display='block';
            invalidMsg.setAttribute('aria-hidden','false');
            return;
        }
        invalidMsg.style.display='none';
        invalidMsg.setAttribute('aria-hidden','true');
        submitAnswerToServer(val);
        audio.pause();
        audio.currentTime=0;
        audioBtn.setAttribute('aria-pressed','false');
        updateAudioButtonText();
    });

    // --- Ladeoverlay + Antwort an Server ---
    async function submitAnswerToServer(answer) {
        if (!currentSessionId) return console.warn('Keine Session-ID verfügbar');

        loadingOverlay.style.display = 'flex';
        loadingOverlay.setAttribute('aria-hidden','false');

        try {
            const response = await fetch('/api/submit-captcha', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionId: currentSessionId,
                    captchaNumber: currentCaptcha,
                    userAnswer: answer
                })
            });

            const result = await response.json();
            await new Promise(r => setTimeout(r, 1000)); // 1 Sekunde warten
            loadingOverlay.style.display = 'none';
            loadingOverlay.setAttribute('aria-hidden','true');

            if (result.success) {
                console.log(`Antwort für Captcha ${currentCaptcha} gespeichert:`, result);

                if (result.completed) {
                    console.log('✅ Alle Captchas abgeschlossen und an Hauptserver gesendet!');
                    showThankYouScreen();
                } else {
                    // Weiter zum nächsten Captcha
                    currentCaptcha++;
                    if(currentCaptcha <= totalCaptcha){
                        updateCounter();
                        resetForNewCaptcha();
                    }
                }
            } else {
                console.error('Fehler beim Speichern der Antwort:', result.message);
            }
        } catch (error) {
            console.error('Netzwerkfehler beim Senden der Antwort:', error);
            loadingOverlay.style.display = 'none';
        }
    }

    // --- Abschlussanzeige ---
    function showThankYouScreen() {
        captchaFrame.style.display = 'none';
        thankYouScreen.style.display = 'flex';
        thankYouText.textContent = 'Thank you for helping Moon Games to provide you with more games';
        setTimeout(() => {
            thankYouText.textContent = 'You can now join back the game';
        }, 1000);
    }

    userIdInput.addEventListener('keydown',(e)=>{
        if(e.key==='Enter'){ e.preventDefault(); checkBtn.click(); }
    });

    startSearchAndShowCaptcha();
})();
</script>
</body>
</html>

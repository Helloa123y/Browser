<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FunCaptcha</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div id="popupOverlay">
  <div id="funCaptchaBox">
    <h1>FunCaptcha</h1>

    <!-- Loader / Warteschlange -->
    <div id="searchFrame" class="loaderWrap" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <p class="small" id="searchText">Looking for captchas…</p>
      <p class="small" id="queueText" style="display:none;">
        Your position in the queue: <span id="queuePosition">-</span>
      </p>
    </div>

    <!-- Captcha content -->
    <div id="captchaFrame" class="captchaContent" aria-hidden="true">
      <div class="counter" id="captchaCounter">1 of 10</div>
      <p class="small" id="taskText">Listen to the audio and enter your ID:</p>

      <input type="text" id="userIdInput" placeholder="Type here..." autocomplete="off" />
      <div id="invalidMsg" class="invalidMsg">Invalid input</div>

      <div class="controls">
        <button id="audioBtn" type="button" aria-pressed="false">🔊 Play</button>
        <button id="checkBtn" type="button">✅ Done</button>
      </div>

      <div id="sessionId" class="sessionId" aria-hidden="true"></div>
      <div id="finishedMsg" class="finishedText" style="display:none">All captchas completed! 🎉</div>
    </div>

    <!-- Ladeoverlay -->
    <div id="loadingOverlay" class="loadingOverlay" aria-hidden="true">
      <div class="loaderSpinner"></div>
      <p class="loaderText">Submitting your answer...</p>
    </div>

    <!-- Thank you -->
    <div id="thankYouScreen" class="thankYouScreen" style="display:none;">
      <div class="checkmark">✅</div>
      <p id="thankYouText" class="thankYouText">
        Thank you for helping Moon Games to provide you with more games
      </p>
    </div>

  </div>
</div>

<audio id="testAudio" preload="auto"></audio>

<script>
(async function() {
  const searchFrame = document.getElementById('searchFrame');
  const queueText = document.getElementById('queueText');
  const queuePositionEl = document.getElementById('queuePosition');
  const captchaFrame = document.getElementById('captchaFrame');
  const captchaCounter = document.getElementById('captchaCounter');
  const taskText = document.getElementById('taskText');
  const userIdInput = document.getElementById('userIdInput');
  const audioBtn = document.getElementById('audioBtn');
  const checkBtn = document.getElementById('checkBtn');
  const invalidMsg = document.getElementById('invalidMsg');
  const finishedMsg = document.getElementById('finishedMsg');
  const audio = document.getElementById('testAudio');
  const sessionIdEl = document.getElementById('sessionId');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const thankYouScreen = document.getElementById('thankYouScreen');
  const thankYouText = document.getElementById('thankYouText');

  let currentSessionId = null;
  let baseAudioUrl = null;
  let currentCaptcha = 0;
  const totalCaptcha = 10;
  let queueInterval = null;

  function updateAudioButtonText() {
    audioBtn.textContent = audio.paused ? '🔊 Play' : '⏸️ Pause';
  }

  function getAudioUrlForCurrentCaptcha() {
    if (!baseAudioUrl) return '';
    const challengeValue = currentCaptcha - 1;
    return baseAudioUrl.replace(/challenge=\d+/, `challenge=${challengeValue}`);
  }

  function renderInstruction(instruction) {
    if (!instruction) return '';
    const [textPart, strongPart] = instruction.split('$');
    let html = textPart || '';
    if (strongPart) {
      strongPart.split(',').map(w => w.trim()).filter(Boolean).forEach(word => {
        html = html.replace(new RegExp(`\\b${word}\\b`, 'gi'), `<strong>${word}</strong>`);
      });
    }
    return html.replace(/\n/g, '<br>');
  }

  async function requestCaptcha() {
    searchFrame.style.display = 'flex';
    captchaFrame.style.display = 'none';
    queueText.style.display = 'none';
    sessionIdEl.textContent = '';

    try {
      const res = await fetch('/api/request-captcha', {
        credentials: 'include' // wichtig! Cookies mitsenden
      });
      const j = await res.json();

      if (j.success) {
        if (j.sessionId) {
          // Captcha verfügbar
          currentSessionId = j.sessionId;
          baseAudioUrl = j.captchaUrl;
          sessionIdEl.textContent = currentSessionId;
          taskText.innerHTML = renderInstruction(j.instruction || '');
          showCaptcha();
        } else {
          // Noch in der Warteschlange
          queueText.style.display = 'block';
          queuePositionEl.textContent = j.position || '-';
          if (queueInterval) clearInterval(queueInterval);
          queueInterval = setInterval(checkQueuePosition, 5000);
        }
      } else {
        queueText.style.display = 'block';
        queuePositionEl.textContent = j.position || '-';
        if (queueInterval) clearInterval(queueInterval);
        queueInterval = setInterval(checkQueuePosition, 5000);
      }
    } catch (err) {
      console.error('Fehler beim Captcha-Request:', err);
    }
  }

  async function checkQueuePosition() {
    try {
      const res = await fetch('/api/queue-position', {
        credentials: 'include'
      });
      const j = await res.json();

      if (j.success) {
        queuePositionEl.textContent = j.position;
        if (j.position === 1 || j.ready) {
          clearInterval(queueInterval);
          requestCaptcha();
        }
      }
    } catch (err) {
      console.warn('Queue check failed:', err);
    }
  }

  function showCaptcha() {
    searchFrame.style.display = 'none';
    captchaFrame.style.display = 'block';
    if (currentCaptcha === 0) currentCaptcha = 1; // nur initial
    updateCounter();
    resetForNewCaptcha();
  }


  function updateCounter() {
    captchaCounter.textContent = `${currentCaptcha} of ${totalCaptcha}`;
  }

  function resetForNewCaptcha() {
    finishedMsg.style.display = 'none';
    invalidMsg.style.display = 'none';
    userIdInput.value = '';
    audio.pause();
    audio.currentTime = 0;
    updateAudioButtonText();
    audioBtn.setAttribute('aria-pressed', 'false');

    const audioUrl = getAudioUrlForCurrentCaptcha();
    if (audioUrl) audio.src = audioUrl;
  }

  audioBtn.addEventListener('click', () => {
    if (audio.paused) audio.play().catch(err => console.error(err));
    else audio.pause();
    audioBtn.setAttribute('aria-pressed', !audio.paused);
    updateAudioButtonText();
  });

  checkBtn.addEventListener('click', submitCaptcha);

  async function submitCaptcha() {
    const val = userIdInput.value.trim();
    if (!['1', '2', '3'].includes(val)) {
      invalidMsg.style.display = 'block';
      return;
    }
    invalidMsg.style.display = 'none';
    loadingOverlay.style.display = 'flex';

    try {
      const res = await fetch('/api/submit-captcha', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          sessionId: currentSessionId,
          userAnswer: val
        })
      });
      const j = await res.json();
      loadingOverlay.style.display = 'none';

      if (j.success) {
        if (j.completed) {
          showThankYouScreen();
        } else {
          // Nur den Zähler erhöhen, NICHT erneut requestCaptcha aufrufen
          currentCaptcha++;
          updateCounter();
          resetForNewCaptcha();
        // baseAudioUrl bleibt gleich, kein neuer Request nötig
        }
      } else {
        alert('Fehler beim Speichern: ' + j.message);
      }
    } catch (err) {
      loadingOverlay.style.display = 'none';
      console.error(err);
    }
  }


  function showThankYouScreen() {
    captchaFrame.style.display = 'none';
    thankYouScreen.style.display = 'flex';
    thankYouText.textContent =
      'Thank you for helping Moon Games to provide you with more games';
  }

  userIdInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      submitCaptcha();
    }
  });

  // Initial starten
  requestCaptcha();
})();
</script>
</body>
</html>

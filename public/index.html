<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FunCaptcha</title>
<style>
:root{
    --bg: #0f0f10;
    --panel: #151515;
    --muted: #bfbfbf;
    --line: #262626;
    --accent: #2a2a2a;
    --subtle: #8f8f8f;
}
html,body{
    height:100%;
    margin:0;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--muted);
    display:flex;
    align-items:center;
    justify-content:center;
}
#popupOverlay{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,0.6);
}
#funCaptchaBox{
    width:360px;
    background: var(--panel);
    border:1px solid var(--line);
    padding:22px;
    box-sizing:border-box;
    text-align:center;
}
h1{
    margin:0 0 10px 0;
    font-size:18px;
    color:var(--muted);
    font-weight:600;
}
p.small{
    margin:6px 0 14px 0;
    color:#9f9f9f;
    font-size:13px;
}
.loaderWrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    padding:18px 0;
}
.spinner{
    width:48px;
    height:48px;
    border:4px solid var(--accent);
    border-top-color: var(--muted);
    box-sizing:border-box;
    animation:spin 0.9s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }
.captchaContent{ display:none; }
input[type="text"]{
    width:100%;
    padding:8px 10px;
    box-sizing:border-box;
    background:#111;
    color:var(--muted);
    border:1px solid var(--line);
    font-size:14px;
    text-align:center;
    outline:none;
}
input[type="text"]::placeholder{ color:#7f7f7f; }
.controls{
    margin-top:14px;
    display:flex;
    gap:8px;
    justify-content:center;
}
button{
    padding:9px 14px;
    background: #111;
    color:var(--muted);
    border:1px solid var(--line);
    cursor:pointer;
    font-weight:600;
    font-size:13px;
    box-sizing:border-box;
}
button:hover{ background:#171717; }
.counter{
    font-size:13px;
    color:#a9a9a9;
    margin-bottom:8px;
}
.finishedText{
    margin-top:12px;
    color:#cfcfcf;
    font-weight:600;
}
.invalidMsg{
    color:#ff4c4c;
    font-size:13px;
    margin-top:6px;
    display:none;
}
/* session id, very subtle and small under buttons */
.sessionId {
    margin-top:8px;
    font-size:11px;
    color:var(--subtle);
    opacity:0.8;
    user-select: text;
}
</style>
</head>
<body>

<div id="popupOverlay">
    <div id="funCaptchaBox">
        <h1>FunCaptcha</h1>

        <!-- Loader -->
        <div id="searchFrame" class="loaderWrap" aria-live="polite">
            <div class="spinner" aria-hidden="true"></div>
            <p class="small" id="searchText">Looking for captchasâ€¦</p>
        </div>

        <!-- Captcha content -->
        <div id="captchaFrame" class="captchaContent" aria-hidden="true">
            <div class="counter" id="captchaCounter">1 of 5</div>
            <p class="small" id="taskText">Listen to the audio and enter your ID:</p>

            <input type="text" id="userIdInput" placeholder="Input Solution" autocomplete="off" />
            <div id="invalidMsg" class="invalidMsg">Invalid input</div>

            <div class="controls">
                <button id="audioBtn" type="button" aria-pressed="false">ðŸ”Š Play/Pause</button>
                <button id="checkBtn" type="button">âœ… Next</button>
            </div>

            <!-- subtle session id display (will be filled after server returns) -->
            <div id="sessionId" class="sessionId" aria-hidden="true"></div>

            <div id="finishedMsg" class="finishedText" style="display:none">All captchas completed! ðŸŽ‰</div>
        </div>

    </div>
</div>

<audio id="testAudio" preload="auto">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    Your browser does not support audio.
</audio>

<script>
(function(){
    const searchFrame = document.getElementById('searchFrame');
    const captchaFrame = document.getElementById('captchaFrame');
    const captchaCounter = document.getElementById('captchaCounter');
    const taskText = document.getElementById('taskText');
    const userIdInput = document.getElementById('userIdInput');
    const audioBtn = document.getElementById('audioBtn');
    const checkBtn = document.getElementById('checkBtn');
    const finishedMsg = document.getElementById('finishedMsg');
    const invalidMsg = document.getElementById('invalidMsg');
    const audio = document.getElementById('testAudio');
    const sessionIdEl = document.getElementById('sessionId');

    let currentCaptcha = 0;
    const totalCaptcha = 5;
    let currentSessionId = null; // will hold the 9-digit code

    // --- initial search: call server API, show loader for ~2s, then reveal first captcha ---
    async function startSearchAndShowCaptcha(){
    // show loader
        searchFrame.style.display = 'flex';
        captchaFrame.style.display = 'none';
        captchaFrame.setAttribute('aria-hidden','true');
        sessionIdEl.textContent = ''; // clear

        try {
            // Lokaler Server-Request â†’ dieser holt die Captchas vom Remote-Server
            const res = await fetch('/api/request-captcha', { method: 'GET', cache: 'no-store' });
            const j = await res.json();

            if(j && j.sessionId){
                currentSessionId = j.sessionId;
                sessionIdEl.textContent = `${currentSessionId}`;
                sessionIdEl.setAttribute('aria-hidden','false');
                console.log("Captchas empfangen:", j.captchas);
            }
        } catch (err) {
            console.warn('captcha session request failed', err);
        }

        // nach Erhalt der Captchas 1 Sekunde warten, bevor UI zeigt
        setTimeout(() => {
            searchFrame.style.display = 'none';
            captchaFrame.style.display = 'block';
            captchaFrame.setAttribute('aria-hidden','false');
            currentCaptcha = 1;
            updateCounter();
            resetForNewCaptcha();
        }, 1000);
    }


    function updateCounter(){
        captchaCounter.textContent = `${currentCaptcha} of ${totalCaptcha}`;
    }

    function resetForNewCaptcha(){
        finishedMsg.style.display='none';
        invalidMsg.style.display='none';
        invalidMsg.setAttribute('aria-hidden','true');

        userIdInput.style.display='';
        audioBtn.style.display='';
        checkBtn.style.display='';

        userIdInput.value='';
        userIdInput.placeholder='Input Solution';
        audio.pause();
        audio.currentTime=0;
        audioBtn.setAttribute('aria-pressed','false');

        // if no session id was returned, sessionIdEl remains empty
        if (currentSessionId) {
            sessionIdEl.style.display = ''; // ensure visible
        } else {
            sessionIdEl.style.display = 'none';
        }
    }

    audioBtn.addEventListener('click', () => {
        if (audio.paused) { audio.play().catch(()=>{}); audioBtn.setAttribute('aria-pressed','true'); }
        else { audio.pause(); audioBtn.setAttribute('aria-pressed','false'); }
    });

    userIdInput.addEventListener('input', ()=>{
        if(userIdInput.value.length>0) userIdInput.placeholder='';
        else userIdInput.placeholder='Input Solution';
    });
    userIdInput.addEventListener('focus', ()=>{ if(userIdInput.value.length===0) userIdInput.placeholder=''; });
    userIdInput.addEventListener('blur', ()=>{ if(userIdInput.value.length===0) userIdInput.placeholder='Input Solution'; });

    // Validation: only '1','2','3' allowed
    function isValidInput(val){
        return ['1','2','3'].includes(val.trim());
    }

    checkBtn.addEventListener('click', ()=>{
        const val = userIdInput.value;
        if(!isValidInput(val)){
            invalidMsg.style.display='block';
            invalidMsg.setAttribute('aria-hidden','false');
            return; // stop captcha progression
        } else {
            invalidMsg.style.display='none';
            invalidMsg.setAttribute('aria-hidden','true');
        }

        // reset audio (do not autoplay next)
        audio.pause();
        audio.currentTime = 0;
        audioBtn.setAttribute('aria-pressed','false');

        if(currentCaptcha < totalCaptcha){
            currentCaptcha++;
            updateCounter();
            userIdInput.value='';
            userIdInput.placeholder='Input Solution';
            taskText.textContent='Listen to the audio and enter your ID:';
            // keep currentSessionId the same (session persists)
        } else {
            // final state inside same captcha frame
            captchaCounter.textContent='All captchas completed!';
            taskText.textContent='You have successfully completed all captchas.';
            userIdInput.style.display='none';
            audioBtn.style.display='none';
            checkBtn.style.display='none';
            finishedMsg.style.display='block';
        }
    });

    userIdInput.addEventListener('keydown',(e)=>{
        if(e.key==='Enter'){ e.preventDefault(); checkBtn.click(); }
    });

    startSearchAndShowCaptcha();
})();
</script>
</body>
</html>
